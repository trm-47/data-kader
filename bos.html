<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Database Kader Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-red: #D71920; --dark-slate: #1e293b; --bg-gray: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-gray); color: var(--dark-slate); padding: 15px; }

        /* HEADER */
        .admin-header { display: flex; align-items: center; gap: 20px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-header img { height: 60px; width: auto; }
        .header-text h1 { font-size: 22px; font-weight: 800; color: var(--primary-red); }
        .header-text p { font-size: 12px; color: #64748b; }

        /* STATS BOX */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 16px; border-top: 4px solid var(--primary-red); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .stat-card small { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        .stat-card h2 { font-size: 20px; margin-top: 5px; }

        /* FILTER PANEL */
        .filter-container { background: white; border-radius: 30px; margin-bottom: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.06); overflow: hidden; }
        .filter-header { padding: 20px 30px; background: linear-gradient(135deg, var(--primary-red) 0%, #a50e13 100%); cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: white; margin-top: 0; }
        .filter-body { padding: 30px; display: none; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; background: #ffffff; }
        .filter-body.active { display: grid; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-group label { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-left: 10px; }
        .filter-group select { padding: 14px 20px; border-radius: 20px; border: 2px solid #f1f5f9; font-size: 13px; font-weight: 600; background-color: #f8fafc; outline: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2364748b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: calc(100% - 20px) center; }

        .btn-reset { grid-column: 1 / -1; padding: 15px; background: #fdf2f2; border: none; border-radius: 20px; cursor: pointer; font-weight: 800; color: var(--primary-red); text-transform: uppercase; }

        /* SEARCH CONTROL */
        .control-panel { background: white; padding: 20px 25px; border-radius: 30px; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.04); }
        .search-box input { width: 100%; padding: 15px 20px; border-radius: 20px; border: 2px solid #f1f5f9; outline: none; font-size: 14px; background-color: #f8fafc; }

        /* TABLE */
        .table-card { background: white; border-radius: 20px; overflow-x: auto; box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        tr:hover td { background: #fff1f2; cursor: pointer; }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; display: inline-block; }
        .badge-red { background: #fee2e2; color: var(--primary-red); }
        .badge-gray { background: #f1f5f9; color: #475569; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 800px; margin: 30px auto; border-radius: 24px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; }

        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border-bottom: 2px solid #f1f5f9; margin-bottom: 10px; padding: 10px; }
            td { border: none; position: relative; padding-left: 50%; text-align: right; }
            td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; font-weight: 800; font-size: 10px; color: #94a3b8; text-align: left; text-transform: uppercase; }
        }
    </style>
</head>
<body>

    <div class="admin-header">
        <img src="https://i.ibb.co.com/N2K0XRMW/logo-pdi.png" alt="Logo PDI">
        <div class="header-text">
            <h1>DATA KADER</h1>
            <p>DPD PDI PERJUANGAN D.I. YOGYAKARTA</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><small>Total Kader</small><h2 id="statTotal">-</h2></div>
        <div class="stat-card"><small>Rata Usia</small><h2 id="statAge">-</h2></div>
        <div class="stat-card"><small>Gen Z & Milenial</small><h2 id="statYoung">-</h2></div>
        <div class="stat-card"><small>Melek Digital</small><h2 id="statArea">-</h2></div>
    </div>

    <div class="filter-container">
        <div class="filter-header" onclick="toggleFilter()">
            <span>FILTER DATA</span>
            <span id="filterIcon">▼</span>
        </div>
        <div id="filterBody" class="filter-body">
            <div class="filter-group">
                <label>Kabupaten / Kota</label>
                <select id="fKota" onchange="updateKecamatan()">
                    <option value="Semua">Semua Wilayah</option>
                    <option value="Yogyakarta">Kota Yogyakarta</option>
                    <option value="Sleman">Sleman</option>
                    <option value="Bantul">Bantul</option>
                    <option value="Gunungkidul">Gunungkidul</option>
                    <option value="Kulon Progo">Kulon Progo</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Kecamatan</label>
                <select id="fKec" onchange="updateDesa()">
                    <option value="Semua">Pilih Kota Dahulu</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Kelurahan / Desa</label>
                <select id="fDesa" onchange="applyFilters()">
                    <option value="Semua">Pilih Kecamatan Dahulu</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Jenis Kelamin</label>
                <select id="fJK" onchange="applyFilters()">
                    <option value="Semua">Semua Jenis Kelamin</option>
                    <option value="Laki-laki">Laki-laki</option>
                    <option value="Perempuan">Perempuan</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Agama</label>
                <select id="fAgama" onchange="applyFilters()">
                    <option value="Semua">Semua Agama</option>
                    <option value="Islam">Islam</option><option value="Kristen">Kristen</option><option value="Katolik">Katolik</option><option value="Hindu">Hindu</option><option value="Budha">Budha</option><option value="Khonghucu">Khonghucu</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Jenjang Pendidikan</label>
                <select id="fPendidikan" onchange="applyFilters()">
                    <option value="Semua">Semua Jenjang</option>
                    <option value="SD">SD</option><option value="SMP">SMP</option><option value="SMA/SMK">SMA/SMK</option><option value="D1">D1</option><option value="D2">D2</option><option value="D3">D3</option><option value="S1">S1</option><option value="S2">S2</option><option value="S3">S3</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Pendidikan Kader</label>
                <select id="fKader" onchange="applyFilters()">
                    <option value="Semua">Semua Tingkat</option>
                    <option value="Pratama">Kader Pratama</option><option value="Madya">Kader Madya</option><option value="Utama">Kader Utama</option><option value="Guru">Guru Kader</option><option value="Perempuan">Kader Perempuan</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Tingkatan Struktur</label>
                <select id="fTingkat" onchange="applyFilters()">
                    <option value="Semua">Semua Tingkatan</option>
                    <option value="DPP">DPP</option><option value="DPD">DPD</option><option value="DPC">DPC</option><option value="PAC">PAC</option><option value="Ranting">Ranting</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Jenis Penugasan</label>
                <select id="fJenisTugas" onchange="applyFilters()">
                    <option value="Semua">Semua Penugasan</option>
                    <option value="Legislatif">Legislatif</option><option value="Eksekutif">Eksekutif</option><option value="Struktural">Struktural</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Bahasa Asing</label>
                <select id="fBahasa" onchange="applyFilters()">
                    <option value="Semua">Semua Kemampuan</option>
                    <option value="Ya">Bisa Bahasa Asing</option><option value="-">Tidak</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Kompetensi IT</label>
                <select id="fIT" onchange="applyFilters()">
                    <option value="Semua">Semua</option><option value="Ya">Bisa</option><option value="-">Tidak Bisa</option>
                </select>
            </div>
            <button class="btn-reset" onclick="resetFilters()">Reset Filter</button>
        </div>
    </div>

    <div class="control-panel">
        <div class="search-box">
            <input type="text" id="quickSearch" onkeyup="doSearch()" placeholder="Cari Nama, NIK, atau Kecamatan...">
        </div>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th style="width:80px">Foto</th>
                    <th>Identitas</th>
                    <th>Usia & Gen</th>
                    <th>Pendidikan</th>
                    <th>Kaderisasi</th>
                </tr>
            </thead>
            <tbody id="bodyKader">
                <tr><td colspan="5" style="text-align:center; padding:50px;">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="modalDetail" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeDetail()">×</span>
            <div id="modalInnerContent"></div>
        </div>
    </div>

<script>
    const URL_GAS = "https://script.google.com/macros/s/AKfycbysCjLQBPyogM4c7_ohGuggfm7JwjOBQo1BS4fG4axFbldk8W5JNAFF9VVLyZx-Jo-i2A/exec";
    let databaseKader = [];

    async function fetchData() {
        try {
            const response = await fetch(URL_GAS + "?action=read");
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            databaseKader = data;
            renderTable(data);
            updateStats(data);
        } catch (error) {
            document.getElementById('bodyKader').innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Gagal: ${error.message}</td></tr>`;
        }
    }

    // --- CASCADING WILAYAH LOGIC ---
    function updateKecamatan() {
        const kotaVal = document.getElementById('fKota').value;
        const kecSelect = document.getElementById('fKec');
        const desaSelect = document.getElementById('fDesa');
        
        kecSelect.innerHTML = '<option value="Semua">Semua Kecamatan</option>';
        desaSelect.innerHTML = '<option value="Semua">Pilih Kecamatan Dahulu</option>';

        if (kotaVal !== "Semua") {
            const listKec = [...new Set(databaseKader
                .filter(item => (item.pribadi.kota === kotaVal || item.pribadi.kab_kota === kotaVal))
                .map(item => item.pribadi.kec)
                .filter(k => k && k !== "-")
            )].sort();
            listKec.forEach(k => kecSelect.innerHTML += `<option value="${k}">${k}</option>`);
        }
        applyFilters();
    }

    function updateDesa() {
        const kecVal = document.getElementById('fKec').value;
        const desaSelect = document.getElementById('fDesa');
        
        desaSelect.innerHTML = '<option value="Semua">Semua Desa</option>';

        if (kecVal !== "Semua") {
            const listDesa = [...new Set(databaseKader
                .filter(item => item.pribadi.kec === kecVal)
                .map(item => item.pribadi.desa)
                .filter(d => d && d !== "-")
            )].sort();
            listDesa.forEach(d => desaSelect.innerHTML += `<option value="${d}">${d}</option>`);
        }
        applyFilters();
    }

    function applyFilters() {
        const filters = {
            kota: document.getElementById('fKota').value,
            kec: document.getElementById('fKec').value,
            desa: document.getElementById('fDesa').value,
            jk: document.getElementById('fJK').value,
            agama: document.getElementById('fAgama').value,
            edu: document.getElementById('fPendidikan').value,
            kader: document.getElementById('fKader').value,
            tingkat: document.getElementById('fTingkat').value,
            it: document.getElementById('fIT').value,
            bahasa: document.getElementById('fBahasa').value
        };

        const filtered = databaseKader.filter(item => {
            const p = item.pribadi || {};
            const f = item.formal || [];
            const k = item.kaderisasi || [];
            const m = item.medsos || [];
            const j = item.jabatan || [];

            const mKota = filters.kota === "Semua" || (p.kota === filters.kota || p.kab_kota === filters.kota);
            const mKec = filters.kec === "Semua" || p.kec === filters.kec;
            const mDesa = filters.desa === "Semua" || p.desa === filters.desa;
            const mJK = filters.jk === "Semua" || p.jk === filters.jk;
            const mAgama = filters.agama === "Semua" || p.agama === filters.agama;
            const mEdu = filters.edu === "Semua" || (f[19] && f[19].toString().includes(filters.edu));
            
            let mKader = filters.kader === "Semua";
            if (!mKader) {
                const mapKader = { "Pratama": 2, "Madya": 4, "Utama": 6, "Guru": 8, "Perempuan": 10 };
                mKader = k[mapKader[filters.kader]] && k[mapKader[filters.kader]] !== "-";
            }

            const txtJabat = j.map(row => row.join(" ")).join(" ").toLowerCase();
            const mTingkat = filters.tingkat === "Semua" || txtJabat.includes(filters.tingkat.toLowerCase());
            
            const mIT = filters.it === "Semua" || (filters.it === "Ya" ? (m[8] && m[8] !== "-") : (!m[8] || m[8] === "-"));
            const mBahasa = filters.bahasa === "Semua" || (filters.bahasa === "Ya" ? (m[3] && m[3] !== "-") : (!m[3] || m[3] === "-"));

            return mKota && mKec && mDesa && mJK && mAgama && mEdu && mKader && mTingkat && mIT && mBahasa;
        });

        renderTable(filtered);
        updateStats(filtered);
    }

    // --- OTHER HELPERS ---
    function calculateAge(tgl) {
        if (!tgl || tgl === "-") return { age: "-", gen: "-", rawAge: 0 };
        const birth = new Date(tgl);
        if (isNaN(birth.getTime())) return { age: "-", gen: "-", rawAge: 0 };
        const now = new Date();
        let age = now.getFullYear() - birth.getFullYear();
        if (now.getMonth() < birth.getMonth() || (now.getMonth() === birth.getMonth() && now.getDate() < birth.getDate())) age--;
        const y = birth.getFullYear();
        let g = "Lainnya";
        if (y >= 1997 && y <= 2012) g = "Gen Z";
        else if (y >= 1981 && y <= 1996) g = "Millennial";
        else if (y >= 1965 && y <= 1980) g = "Gen X";
        else if (y <= 1964) g = "Boomer";
        return { age: age + " Thn", gen: g, rawAge: age };
    }

    function renderTable(data) {
        const body = document.getElementById('bodyKader');
        body.innerHTML = "";
        if (!data || data.length === 0) {
            body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:50px;">Data tidak ditemukan.</td></tr>';
            return;
        }
        [...data].reverse().forEach((item) => {
            const p = item.pribadi;
            const ageInfo = calculateAge(p.tgl_lahir);
            const originalIdx = databaseKader.indexOf(item);
            body.innerHTML += `
                <tr onclick="openDetail(${originalIdx})">
                    <td data-label="Foto"><img src="${formatDriveUrl(p.foto)}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.nama)}&background=random'" style="width:45px; height:45px; border-radius:10px; object-fit:cover;"></td>
                    <td data-label="Identitas"><strong>${p.nama || 'Tanpa Nama'}</strong><br><small>${p.nik || '-'}</small></td>
                    <td data-label="Usia">${ageInfo.age}<br><span class="badge badge-gray">${ageInfo.gen}</span></td>
                    <td data-label="Pendidikan"><strong>${p.kec || '-'}</strong></td>
                    <td data-label="Kaderisasi"><span class="badge badge-red">Terverifikasi</span></td>
                </tr>`;
        });
    }

    function updateStats(data) {
        const total = data.length;
        let sumAge = 0, countAge = 0, youth = 0, it = 0;
        data.forEach(item => {
            const a = calculateAge(item.pribadi.tgl_lahir);
            if (a.rawAge > 0) { sumAge += a.rawAge; countAge++; }
            if (a.gen === "Gen Z" || a.gen === "Millennial") youth++;
            if (item.medsos && item.medsos[8] && item.medsos[8] !== "-") it++;
        });
        document.getElementById('statTotal').innerText = total;
        document.getElementById('statAge').innerText = countAge > 0 ? Math.round(sumAge / countAge) + " Thn" : "-";
        document.getElementById('statYoung').innerText = total > 0 ? Math.round((youth / total) * 100) + "%" : "0%";
        document.getElementById('statArea').innerText = total > 0 ? Math.round((it / total) * 100) + "%" : "0%";
    }

    function formatDriveUrl(url) {
        if (!url || !url.includes("id=")) return url;
        const id = url.split("id=")[1].split("&")[0];
        return `https://docs.google.com/uc?export=view&id=${id}`;
    }

    function toggleFilter() {
        const b = document.getElementById('filterBody');
        const i = document.getElementById('filterIcon');
        b.classList.toggle('active');
        i.innerText = b.classList.contains('active') ? '▲' : '▼';
    }

    function resetFilters() {
        document.querySelectorAll('select').forEach(s => s.value = 'Semua');
        document.getElementById('fKec').innerHTML = '<option value="Semua">Pilih Kota Dahulu</option>';
        document.getElementById('fDesa').innerHTML = '<option value="Semua">Pilih Kecamatan Dahulu</option>';
        applyFilters();
    }

    function doSearch() {
        const v = document.getElementById('quickSearch').value.toLowerCase();
        document.querySelectorAll('#bodyKader tr').forEach(r => {
            r.style.display = r.innerText.toLowerCase().includes(v) ? "" : "none";
        });
    }

    function openDetail(idx) {
        const p = databaseKader[idx].pribadi;
        const age = calculateAge(p.tgl_lahir);
        document.getElementById('modalInnerContent').innerHTML = `
            <div style="text-align:center">
                <img src="${formatDriveUrl(p.foto)}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border: 3px solid #eee;">
                <h2 style="margin-top:10px;">${p.nama}</h2>
                <p>NIK: ${p.nik}</p><hr style="margin:15px 0">
                <p><b>Wilayah:</b> ${p.desa || '-'}, ${p.kec || '-'}, ${p.kota || '-'}</p>
                <p><b>Usia:</b> ${age.age} (${age.gen})</p>
                <p><b>WA:</b> ${p.wa || '-'}</p>
            </div>`;
        document.getElementById('modalDetail').style.display = "block";
    }

    function closeDetail() { document.getElementById('modalDetail').style.display = "none"; }
    window.onload = fetchData;
</script>
</body>
</html>
