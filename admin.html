<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Database Kader Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-red: #D71920; --dark-slate: #1e293b; --bg-gray: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-gray); color: var(--dark-slate); padding: 15px; }

        /* HEADER */
        .admin-header { display: flex; align-items: center; gap: 20px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-header img { height: 60px; width: auto; }
        .header-text h1 { font-size: 22px; font-weight: 800; color: var(--primary-red); }
        .header-text p { font-size: 12px; color: #64748b; }

        /* STATS BOX */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 16px; border-top: 4px solid var(--primary-red); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .stat-card small { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        .stat-card h2 { font-size: 20px; margin-top: 5px; }

        /* CONTROL PANEL */
        .control-panel { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 15px rgba(0,0,0,0.05); overflow: hidden; transition: 0.3s; }
        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 12px; border: 2px solid #f1f5f9; outline: none; font-size: 14px; }
        .search-box::before { content: 'üîç'; position: absolute; left: 15px; top: 12px; opacity: 0.5; }

        /* TABLE */
        .table-card { background: white; border-radius: 20px; overflow-x: auto; box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        tr:hover td { background: #fff1f2; cursor: pointer; }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; display: inline-block; }
        .badge-red { background: #fee2e2; color: var(--primary-red); }
        .badge-gray { background: #f1f5f9; color: #475569; margin-top: 4px; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 800px; margin: 30px auto; border-radius: 24px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; }

        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border-bottom: 2px solid #f1f5f9; margin-bottom: 10px; padding: 10px; }
            td { border: none; position: relative; padding-left: 50%; text-align: right; }
            td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; font-weight: 800; font-size: 10px; color: #94a3b8; text-align: left; text-transform: uppercase; }
        }
    </style>
</head>
<body>

    <div class="admin-header">
        <img src="https://i.ibb.co.com/N2K0XRMW/logo-pdi.png" alt="Logo PDI">
        <div class="header-text">
            <h1>DATA KADER</h1>
            <p>DPD PDI PERJUANGAN D.I. YOGYAKARTA</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><small>Total Kader</small><h2 id="statTotal">-</h2></div>
        <div class="stat-card"><small>Rata Usia</small><h2 id="statAge">-</h2></div>
        <div class="stat-card"><small>Gen Z & Milenial</small><h2 id="statYoung">-</h2></div>
        <div class="stat-card"><small>Wilayah Aktif</small><h2 id="statArea">-</h2></div>
    </div>

    <div class="control-panel">
        <div class="search-box">
            <input type="text" id="quickSearch" onkeyup="doSearch()" placeholder="Cari Nama, NIK, atau Kecamatan...">
        </div>
    </div>

    <div class="table-card">
        <table>
            <thead>
                <tr>
                    <th style="width:80px">Foto</th>
                    <th>Identitas</th>
                    <th>Usia & Gen</th>
                    <th>Domisili</th>
                    <th>Kaderisasi</th>
                </tr>
            </thead>
            <tbody id="bodyKader">
                <tr><td colspan="5" style="text-align:center; padding:50px;">Memuat data...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="modalDetail" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeDetail()">√ó</span>
            <div id="modalInnerContent"></div>
        </div>
    </div>

<script>
    const URL_GAS = "https://script.google.com/macros/s/AKfycbxkJvV91JScSI1-sRnrXHBcCtyMHijo8418EnC2D2W0MkgFXPInjaQIhceZgiXS6LakKQ/exec";
    let databaseKader = [];

    async function fetchData() {
try {
        console.log("Memulai penarikan data...");
        const response = await fetch(URL_GAS + "?action=read");
        const data = await response.json();
        
        console.log("Data diterima:", data); // Cek di Inspect Element > Console

        if (data.error) {
            throw new Error(data.error);
        }

        databaseKader = data;
        renderTable(data);
        updateStats(data);
    } catch (error) {
        console.error("Error Detail:", error);
        document.getElementById('bodyKader').innerHTML = `
            <tr><td colspan="5" style="text-align:center; color:red; padding:20px;">
                Gagal memuat data: ${error.message}<br>
                <small>Pastikan Deployment GAS sudah benar dan "Anyone" bisa akses.</small>
            </td></tr>`;
    }
}

function calculateAge(birthDateString) {
    if (!birthDateString || birthDateString === "-" || birthDateString === "") {
        return { age: "-", gen: "-", rawAge: 0 };
    }

    try {
        // Memastikan input menjadi objek Date
        let birthDate = new Date(birthDateString);
        
        // Jika format di Sheet aneh, coba paksa konversi
        if (isNaN(birthDate.getTime())) {
            return { age: "-", gen: "-", rawAge: 0 };
        }

        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;

        const year = birthDate.getFullYear();
        let gen = "Lainnya";
        if (year >= 1997 && year <= 2012) gen = "Gen Z";
        else if (year >= 1981 && year <= 1996) gen = "Millennial";
        else if (year >= 1965 && year <= 1980) gen = "Gen X";
        else if (year <= 1964) gen = "Boomer";

        return { age: age + " Thn", gen: gen, rawAge: age };
    } catch (e) {
        return { age: "-", gen: "-", rawAge: 0 };
    }
}

    function renderTable(data) {
    const body = document.getElementById('bodyKader');
    if (!body) return;
    body.innerHTML = "";
    
    if (!data || data.length === 0) {
        body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:50px;">Data tidak ditemukan.</td></tr>';
        return;
    }

    const displayData = [...data].reverse();

    displayData.forEach((item) => {
        if (!item || !item.pribadi) return;

        const p = item.pribadi;
        
        // --- FOKUS 1: UMUR ---
        const ageInfo = calculateAge(p.tgl_lahir);
        
        // --- FOKUS 2: TINGKAT KADERISASI ---
        // Kita cek baris dari Pendidikan_Kader (item.kaderisasi)
        // Berdasarkan baris: .appendRow([timestamp, nik, pk.pt, pk.pp, pk.mt, pk.mp, pk.ut, pk.up, pk.gt, pk.gp...])
        let statusKader = "Anggota"; 
        const k = item.kaderisasi;

        if (k && k.length > 0) {
            if (k[8] && k[8] !== "") statusKader = "Kader Guru";      // Kolom I
            else if (k[6] && k[6] !== "") statusKader = "Kader Utama"; // Kolom G
            else if (k[4] && k[4] !== "") statusKader = "Kader Madya"; // Kolom E
            else if (k[2] && k[2] !== "") statusKader = "Kader Pratama"; // Kolom C
        }

        const originalIdx = databaseKader.indexOf(item);
        const row = `
            <tr onclick="openDetail(${originalIdx})">
                <td data-label="Foto">
                    <img src="${formatDriveUrl(p.foto)}" 
                         onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.nama)}&background=random'" 
                         style="width:45px; height:45px; border-radius:10px; object-fit:cover;">
                </td>
                <td data-label="Identitas">
                    <strong>${p.nama || 'Tanpa Nama'}</strong><br>
                    <small>${p.nik || '-'}</small>
                </td>
                <td data-label="Usia">
                    ${ageInfo.age}<br>
                    <span class="badge badge-gray">${ageInfo.gen}</span>
                </td>
                <td data-label="Domisili">
                    ${p.kec || '-'}<br>
                    <small>${p.kota || '-'}</small>
                </td>
                <td data-label="Kaderisasi">
                    <span class="badge badge-red">${statusKader}</span>
                </td>
            </tr>
        `;
        body.innerHTML += row;
    });
}

function updateStats(data) {
    if (!data || data.length === 0) return;

    const total = data.length;
    let totalAge = 0;
    let youth = 0;
    let countAge = 0;

    data.forEach(item => {
        // --- PROTEKSI DISINI ---
        if (item && item.pribadi && item.pribadi.tgl_lahir) {
            const ageInfo = calculateAge(item.pribadi.tgl_lahir);
            if (ageInfo.rawAge > 0) {
                totalAge += ageInfo.rawAge;
                countAge++;
                if (ageInfo.gen === "Gen Z" || ageInfo.gen === "Millennial") youth++;
            }
        }
    });

    document.getElementById('statTotal').innerText = total;
    document.getElementById('statAge').innerText = countAge > 0 ? Math.round(totalAge / countAge) + " Thn" : "-";
    document.getElementById('statYoung').innerText = total > 0 ? Math.round((youth / total) * 100) + "%" : "-";
    
    // Proteksi untuk hitung kecamatan
    const kecList = data
        .filter(i => i && i.pribadi && i.pribadi.kec)
        .map(i => i.pribadi.kec);
    document.getElementById('statArea').innerText = [...new Set(kecList)].length + " Kec";
}

function formatDriveUrl(url) {
    if (!url || !url.includes("drive.google.com")) return url;
    // Mencari ID file dari link Google Drive
    const parts = url.split("id=");
    let fileId = parts.length > 1 ? parts[1] : url.split("/d/")[1]?.split("/")[0];
    
    if (fileId) {
        // Link thumbnail langsung (lebih cepat & stabil)
        return `https://lh3.googleusercontent.com/d/${fileId}`;
    }
    return url;
}

    function doSearch() {
        const val = document.getElementById('quickSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#bodyKader tr');
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(val) ? "" : "none";
        });
    }

function openDetail(originalIndex) {
    const item = databaseKader[originalIndex];
    if (!item || !item.pribadi) return; // Proteksi jika data klik kosong

    const p = item.pribadi;
    const ageInfo = calculateAge(p.tgl_lahir);
    
    // Ambil status kader (kolom terakhir di sheet Pendidikan Formal)
    const statusKader = (item.formal && item.formal.length > 19) ? item.formal[19] : "Non-Kader";
    
    document.getElementById('modalInnerContent').innerHTML = `
        <div style="text-align:center; margin-bottom:20px;">
            <img src="${formatDriveUrl(p.foto)}" 
                 onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.nama)}&background=random'"
                 style="border-radius:20px; width:120px; height:120px; object-fit:cover; border: 4px solid #f1f5f9;">
            <h2 style="margin-top:10px; color:var(--primary-red);">${p.nama || 'Tanpa Nama'}</h2>
            <span class="badge badge-red">${statusKader}</span>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; font-size:14px; background:#f8fafc; padding:20px; border-radius:15px;">
            <div><small>NIK</small><br><strong>${p.nik || '-'}</strong></div>
            <div><small>Kecamatan</small><br><strong>${p.kec || '-'}</strong></div>
            <div><small>Usia</small><br><strong>${ageInfo.age} (${ageInfo.gen})</strong></div>
            <div><small>Kontak</small><br><strong>${p.wa || '-'}</strong></div>
            <div style="grid-column: span 2;"><small>Alamat</small><br><strong>${p.alamat || '-'}, RT ${p.rt || '0'}/RW ${p.rw || '0'}, ${p.desa || '-'}</strong></div>
        </div>
    `;
    document.getElementById('modalDetail').style.display = "block";
}

    function closeDetail() { document.getElementById('modalDetail').style.display = "none"; }
    
    window.onload = fetchData;
</script>
</body>
</html>
