<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Database Kader Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-red: #D71920; --dark-slate: #1e293b; --bg-gray: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-gray); color: var(--dark-slate); padding: 15px; }

        /* HEADER & LOGO */
        .admin-header { display: flex; align-items: center; gap: 20px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-header img { height: 60px; width: auto; }
        .header-text h1 { font-size: 22px; font-weight: 800; color: var(--primary-red); }
        .header-text p { font-size: 12px; color: #64748b; }

        /* STATS BOX */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 16px; border-top: 4px solid var(--primary-red); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .stat-card small { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        .stat-card h2 { font-size: 20px; margin-top: 5px; }

        /* CONTROL PANEL */
        .control-panel { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 15px rgba(0,0,0,0.05); overflow: hidden; transition: 0.3s; }
        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 12px; border: 2px solid #f1f5f9; outline: none; font-size: 14px; }

        /* TABLE */
        .table-card { background: white; border-radius: 20px; overflow-x: auto; box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; cursor: pointer; }
        tr:hover td { background: #fff1f2; }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; display: inline-block; }
        .badge-red { background: #fee2e2; color: var(--primary-red); }
        .badge-gray { background: #f1f5f9; color: #475569; margin-top: 4px; }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 800px; margin: 30px auto; border-radius: 24px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; }

        /* DETAIL STYLING */
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .detail-section { margin-bottom: 15px; }
        .detail-section h3 { font-size: 13px; color: var(--primary-red); border-bottom: 2px solid #fee2e2; padding-bottom: 5px; margin-bottom: 10px; }
        .detail-section div { font-size: 13px; margin-bottom: 6px; }
        .detail-section strong { font-size: 10px; color: #94a3b8; text-transform: uppercase; display: block; }

        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border-bottom: 2px solid #f1f5f9; margin-bottom: 10px; padding: 10px; }
            td { border: none; position: relative; padding-left: 50%; text-align: right; }
            td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; font-weight: 800; font-size: 10px; color: #94a3b8; text-align: left; text-transform: uppercase; }
            .td-img { text-align: center; padding-left: 0; }
            .td-img:before { display: none; }
        }
    </style>
</head>
<body>

    <div class="admin-header">
        <img src="https://i.ibb.co.com/N2K0XRMW/logo-pdi.png" alt="Logo PDI">
        <div class="header-text">
            <h1>DATA KADER</h1>
            <p>DPD PDI PERJUANGAN D.I. YOGYAKARTA</p>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><small>Total Kader</small><h2 id="statTotal">-</h2></div>
        <div class="stat-card"><small>Domisili Wilayah</small><h2 id="statWilayah">-</h2></div>
        <div class="stat-card"><small>Gen Z & Milenial</small><h2 id="statMuda">-</h2></div>
        <div class="stat-card"><small>Wilayah Aktif</small><h2>DIY</h2></div>
    </div>

    <div class="control-panel">
        <div class="search-box">
            <input type="text" id="quickSearch" onkeyup="doSearch()" placeholder="Cari Nama, NIK, atau Kecamatan...">
        </div>
    </div>

    <div class="table-card">
        <table id="tableKader">
            <thead>
                <tr>
                    <th style="width:80px">Foto</th>
                    <th>Identitas</th>
                    <th>Usia & Gen</th>
                    <th>Domisili</th>
                    <th>Kaderisasi</th>
                </tr>
            </thead>
            <tbody id="bodyKader"></tbody>
        </table>
    </div>

    <div id="modalDetail" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeDetail()">&times;</span>
            <div style="text-align:center; margin-bottom:20px;">
                <img id="detFoto" src="" style="border-radius:20px; width:120px; height:120px; object-fit:cover; border:4px solid #f1f5f9;">
                <h2 id="detNama" style="margin-top:10px; color:var(--primary-red);"></h2>
                <div id="detBadges"></div>
            </div>
            <hr style="opacity:0.1; margin-bottom:20px;">
            <div id="fullInfo"></div>
        </div>
    </div>

<script>
    const URL_GAS = "https://script.google.com/macros/s/AKfycbxYzkbkMLDY_t6pXCMpB48xeApVqFinF-kquS25dsYQkJZt3U49zaTdhi3GgPuOu7z3tQ/exec";
    let databaseKader = [];

    // 1. AMBIL DATA
    async function fetchData() {
        const body = document.getElementById('bodyKader');
        body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:50px;">Memuat data lengkap dari Step 1-6...</td></tr>';
        try {
            const response = await fetch(URL_GAS + "?action=read");
            const data = await response.json();
            databaseKader = data;
            renderTable(databaseKader);
            updateStats(databaseKader);
        } catch (error) {
            body.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Gagal: ${error.message}</td></tr>`;
        }
    }

    // 2. HITUNG UMUR
    function calculateAge(birthDateString) {
        if (!birthDateString) return { age: "-", gen: "-" };
        try {
            let birthDate = new Date(birthDateString);
            if (isNaN(birthDate.getTime())) return { age: "-", gen: "-" };
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            
            const year = birthDate.getFullYear();
            let gen = "Lainnya";
            if (year >= 1997) gen = "Gen Z";
            else if (year >= 1981) gen = "Millennial";
            else if (year >= 1965) gen = "Gen X";
            else gen = "Boomer";

            return { age: age + " Thn", gen: gen };
        } catch(e) { return { age: "-", gen: "-" }; }
    }

    function formatDriveUrl(url) {
        if (!url || url === "-") return "https://via.placeholder.com/150";
        if (url.includes("id=")) return "https://lh3.googleusercontent.com/d/" + url.split("id=")[1];
        return url;
    }

    // 3. RENDER TABEL (DIPERKUAT)
function renderTable(data) {
    const body = document.getElementById('bodyKader');
    body.innerHTML = "";
    
    // Filter data yang tidak memiliki objek pribadi (baris kosong di sheet)
    const validData = data.filter(item => item && item.pribadi && item.pribadi.nama);
    const sortedData = [...validData].reverse();

    if (sortedData.length === 0) {
        body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">Tidak ada data yang valid ditemukan.</td></tr>';
        return;
    }

    sortedData.forEach((item, index) => {
        const p = item.pribadi;
        const ageInfo = calculateAge(p.tgl_lahir);
        
        // Cek tingkat kaderisasi
        let tk = "Non-Kader";
        if(item.kaderisasi && item.kaderisasi[6]) tk = "Utama"; 
        else if(item.kaderisasi && item.kaderisasi[4]) tk = "Madya"; 
        else if(item.kaderisasi && item.kaderisasi[2]) tk = "Pratama";

        body.innerHTML += `
            <tr onclick="openDetail(${index})">
                <td class="td-img" data-label="Foto">
                    <img src="${formatDriveUrl(p.foto)}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.nama)}'" style="width:45px; height:45px; border-radius:10px; object-fit:cover;">
                </td>
                <td data-label="Identitas"><strong>${p.nama || '-'}</strong><br><small>${p.nik || '-'}</small></td>
                <td data-label="Usia">${ageInfo.age}<br><span class="badge badge-gray">${ageInfo.gen}</span></td>
                <td data-label="Domisili">${p.kec || '-'}<br><small>${p.kota || '-'}</small></td>
                <td data-label="Kaderisasi"><span class="badge badge-red">${tk}</span></td>
            </tr>`;
    });
}

// 4. STATISTIK (DIPERKUAT AGAR TIDAK ERROR TGL_LAHIR)
function updateStats(data) {
    const validData = data.filter(item => item && item.pribadi);
    
    document.getElementById('statTotal').innerText = validData.length;
    
    const kecs = [...new Set(validData.map(k => k.pribadi.kec))].filter(Boolean).length;
    document.getElementById('statWilayah').innerText = kecs + " Kec";
    
    const muda = validData.filter(k => {
        if(!k.pribadi.tgl_lahir) return false;
        const res = calculateAge(k.pribadi.tgl_lahir);
        return res.gen === "Gen Z" || res.gen === "Millennial";
    }).length;
    
    const percent = validData.length > 0 ? Math.round((muda/validData.length)*100) : 0;
    document.getElementById('statMuda').innerText = percent + "%";
}

    // 5. DETAIL LENGKAP (MODAL)
    function openDetail(index) {
        const sortedData = [...databaseKader].reverse();
        const item = sortedData[index];
        const p = item.pribadi;
        const f = item.formal;
        const k = item.kaderisasi;
        const m = item.medsos;

        document.getElementById('detFoto').src = formatDriveUrl(p.foto);
        document.getElementById('detNama').innerText = p.nama;
        
        let tk = "Non-Kader";
        if(k[6]) tk = "Utama"; else if(k[4]) tk = "Madya"; else if(k[2]) tk = "Pratama";
        document.getElementById('detBadges').innerHTML = `<span class="badge badge-red">${tk}</span>`;

        let html = `
            <div class="detail-grid">
                <div class="detail-section">
                    <h3>ðŸ“Œ DATA PRIBADI (STEP 1)</h3>
                    <div><strong>NIK</strong>${p.nik}</div>
                    <div><strong>TTL</strong>${p.tmpt_lahir}, ${p.tgl_lahir}</div>
                    <div><strong>ALAMAT</strong>${p.alamat}, RT ${p.rt}/RW ${p.rw}, ${p.desa}, ${p.kec}, ${p.kota}</div>
                    <div><strong>WA</strong>${p.wa}</div>
                    <div><strong>PEKERJAAN</strong>${p.kerja_skrg}</div>
                </div>
                <div class="detail-section">
                    <h3>ðŸŽ“ PENDIDIKAN FORMAL (STEP 2)</h3>
                    <div><strong>Terakhir</strong>${f[19] || '-'}</div>
                    <div><strong>Institusi</strong>${f[11] || f[6] || '-'}</div>
                    <div><strong>Tahun Lulus</strong>${f[14] || '-'}</div>
                </div>
                <div class="detail-section">
                    <h3>ðŸš© KADERISASI (STEP 3)</h3>
                    <div><strong>Tingkat</strong>${tk}</div>
                    <div><strong>Info Tambahan</strong>${k[12] || '-'}</div>
                </div>
                <div class="detail-section">
                    <h3>ðŸ“± MEDIA SOSIAL (STEP 5)</h3>
                    <div><strong>FB</strong>${m[9] || '-'}</div>
                    <div><strong>IG</strong>${m[10] || '-'}</div>
                    <div><strong>TikTok</strong>${m[11] || '-'}</div>
                    <div><strong>YouTube</strong>${m[13] || '-'}</div>
                </div>
                <div class="detail-section" style="grid-column: 1 / -1;">
                    <h3>ðŸ’¼ JABATAN & ORGANISASI (STEP 4 & 6)</h3>
                    <div style="background:#f1f5f9; padding:10px; border-radius:10px;">
                        <strong>Jabatan Partai</strong>
                        ${item.jabatan.length > 0 ? item.jabatan.map(j => `â€¢ ${j[5]} (${j[8]})`).join('<br>') : 'Tidak ada data'}
                    </div>
                    <div style="background:#f1f5f9; padding:10px; border-radius:10px; margin-top:10px;">
                        <strong>Organisasi Lain</strong>
                        ${item.organisasi.length > 0 ? item.organisasi.map(o => `â€¢ ${o[2]} sebagai ${o[4]}`).join('<br>') : 'Tidak ada data'}
                    </div>
                </div>
            </div>`;
        
        document.getElementById('fullInfo').innerHTML = html;
        document.getElementById('modalDetail').style.display = "block";
    }

    function closeDetail() { document.getElementById('modalDetail').style.display = "none"; }
    function doSearch() {
        let input = document.getElementById('quickSearch').value.toUpperCase();
        let tr = document.getElementById("tableKader").getElementsByTagName("tr");
        for (let i = 1; i < tr.length; i++) {
            let txt = tr[i].textContent || tr[i].innerText;
            tr[i].style.display = txt.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }
    }

    window.onload = fetchData;
</script>
</body>
</html>
