<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Database Kader Digital</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-red: #D71920; --dark-slate: #1e293b; --bg-gray: #f8fafc; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-gray); color: var(--dark-slate); padding: 15px; }

        /* HEADER & LOGO */
        .admin-header { display: flex; align-items: center; gap: 20px; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-header img { height: 60px; width: auto; }
        .header-text h1 { font-size: 22px; font-weight: 800; color: var(--primary-red); }
        .header-text p { font-size: 12px; color: #64748b; }

        /* STATS BOX */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 16px; border-top: 4px solid var(--primary-red); box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .stat-card small { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        .stat-card h2 { font-size: 20px; margin-top: 5px; }

        /* CONTROL PANEL (FILTER & SEARCH) */
        .control-panel { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 10px 15px rgba(0,0,0,0.05); transition: all 0.4s ease; }
        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 12px; border: 2px solid #f1f5f9; outline: none; font-size: 14px; }
        .search-box::before { content: 'üîç'; position: absolute; left: 15px; top: 12px; opacity: 0.5; }

        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
        select { padding: 10px; border-radius: 10px; border: 1px solid #e2e8f0; background: #f8fafc; font-family: inherit; }

        /* TABLE SECTION */
        .table-card { background: white; border-radius: 20px; overflow-x: auto; box-shadow: 0 10px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 11px; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #f1f5f9; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; cursor: pointer; }
        tr:hover td { background: #fff1f2; }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; display: inline-block; }
        .badge-red { background: #fee2e2; color: var(--primary-red); }
        .badge-gray { background: #f1f5f9; color: #475569; margin-top: 4px; }

        /* MODAL DETAIL */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 95%; max-width: 800px; margin: 30px auto; border-radius: 24px; padding: 25px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; }

        /* MOBILE ADAPTATION */
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { border-bottom: 2px solid #f1f5f9; margin-bottom: 10px; padding: 10px; }
            td { border: none; position: relative; padding-left: 50%; text-align: right; }
            td:before { content: attr(data-label); position: absolute; left: 10px; width: 45%; padding-right: 10px; white-space: nowrap; font-weight: 800; font-size: 10px; color: #94a3b8; text-align: left; text-transform: uppercase; }
            .td-img { text-align: center; padding-left: 0; }
            .td-img:before { display: none; }
        }

        /* FAB ANALYTICS */
        .fab-stats { position: fixed; bottom: 25px; right: 25px; background: var(--primary-red); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 20px rgba(215, 25, 32, 0.4); border: none; cursor: pointer; z-index: 1000; transition: 0.3s; }
        .fab-stats:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <div class="admin-header">
        <img src="https://i.ibb.co.com/N2K0XRMW/logo-pdi.png" alt="Logo PDI">
        <div class="header-text">
            <h1>DATA KADER</h1>
            <p>DPD PDI PERJUANGAN D.I. YOGYAKARTA</p>
        </div>
        <button onclick="toggleFilter()" id="btnToggle" style="margin-left: auto; padding: 10px 15px; border-radius: 10px; border: none; background: #f1f5f9; font-weight: 700; cursor: pointer;">
            üìÇ Filter
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><small>Total Kader</small><h2>2,540</h2></div>
        <div class="stat-card"><small>Rata Usia</small><h2>32.5 Thn</h2></div>
        <div class="stat-card"><small>Gen Z & Milenial</small><h2>72%</h2></div>
        <div class="stat-card"><small>Wilayah Aktif</small><h2>31 Kec</h2></div>
    </div>

    <div id="panelFilter" class="control-panel">
        <div class="search-box">
            <input type="text" id="quickSearch" onkeyup="doSearch()" placeholder="Ketik Nama, NIK, atau Kecamatan untuk cari cepat...">
        </div>
        <div class="filter-grid">
            <div class="filter-group">
                <label>Wilayah</label>
                <select><option>Semua Kecamatan</option></select>
            </div>
            <div class="filter-group">
                <label>Generasi</label>
                <select>
                    <option>Semua Generasi</option>
                    <option>Gen Z (< 26 Thn)</option>
                    <option>Millennial (26-41 Thn)</option>
                    <option>Gen X (42-57 Thn)</option>
                    <option>Boomer (> 57 Thn)</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Kaderisasi</label>
                <select><option>Semua Tingkat</option></select>
            </div>
            <div class="filter-group">
                <label>Pekerjaan</label>
                <select><option>Semua Bidang</option></select>
            </div>
        </div>
    </div>

    <div class="table-card">
        <table id="tableKader">
            <thead>
                <tr>
                    <th style="width:80px">Foto</th>
                    <th>Identitas</th>
                    <th>Usia & Gen</th>
                    <th>Domisili</th>
                    <th>Kaderisasi</th>
                </tr>
            </thead>
            <tbody id="bodyKader">
                <tr onclick="openDetail()">
                    <td class="td-img" data-label="Foto"><img src="https://via.placeholder.com/50" style="width:45px; height:45px; border-radius:10px; object-fit:cover;"></td>
                    <td data-label="Identitas"><strong>Andika Wijaya</strong><br><small>3578012304950002</small></td>
                    <td data-label="Usia">29 Thn<br><span class="badge badge-gray">Millennial</span></td>
                    <td data-label="Domisili">Gubeng<br><small>Surabaya</small></td>
                    <td data-label="Kaderisasi"><span class="badge badge-red">Madya</span></td>
                </tr>
            </tbody>
        </table>
    </div>

    <button class="fab-stats" onclick="alert('Membuka Analisa Grafik Statistik...')">üìä</button>

    <div id="modalDetail" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeDetail()">&times;</span>
            <div style="text-align:center; margin-bottom:20px;">
                <img src="https://via.placeholder.com/100" style="border-radius:20px; width:100px; height:100px; object-fit:cover;">
                <h2 style="margin-top:10px;">Andika Wijaya</h2>
                <span class="badge badge-red">Kader Madya</span>
            </div>
            <hr style="opacity:0.1; margin-bottom:20px;">
            <div id="fullInfo" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; font-size:14px;">
                <div><strong>NIK:</strong> 3578012304950002</div>
                <div><strong>Kecamatan:</strong> Gubeng</div>
                <div><strong>WA:</strong> 08123456789</div>
                <div><strong>Pekerjaan:</strong> Wiraswasta</div>
                <div style="grid-column: span 2;"><strong>Alamat:</strong> Jl. Raya Gubeng No. 123, Surabaya</div>
            </div>
        </div>
    </div>

<script>
    // 1. KONFIGURASI - Paste URL Web App dari GAS Bos di sini
    const URL_GAS = "https://script.google.com/macros/s/AKfycbxYzkbkMLDY_t6pXCMpB48xeApVqFinF-kquS25dsYQkJZt3U49zaTdhi3GgPuOu7z3tQ/exec";
    let databaseKader = [];

    // 2. FUNGSI AMBIL DATA (FETCH)
    async function fetchData() {
        const body = document.getElementById('bodyKader');
        body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:50px;">Sedang memuat data kader... Mohon tunggu...</td></tr>';
        
        try {
            const response = await fetch(URL_GAS + "?action=read");
            const data = await response.json();
            
            databaseKader = data;
            
            renderTable(databaseKader);
            updateStats(databaseKader);
            // Fungsi ini sekarang sudah ada di bawah agar tidak error lagi
            populateFilters(databaseKader);
            
        } catch (error) {
            console.error("Error:", error);
            body.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">Gagal memuat data! <br><small>${error.message}</small></td></tr>`;
        }
    }

    // 3. FUNGSI POPULATE FILTERS (BIAR TIDAK ERROR)
    function populateFilters(data) {
        const selectKec = document.querySelector('.filter-group select'); // Select pertama (Wilayah)
        const kecamatans = [...new Set(data.map(k => k.kecamatan))].filter(Boolean);
        
        // Reset dan isi filter kecamatan
        selectKec.innerHTML = '<option value="">Semua Kecamatan</option>';
        kecamatans.forEach(kec => {
            selectKec.innerHTML += `<option value="${kec}">${kec}</option>`;
        });
    }

    // 4. FUNGSI HITUNG USIA & GEN
function calculateAge(birthDateString) {
    if (!birthDateString || birthDateString === "-" || birthDateString === "") {
        return { age: "-", gen: "-" };
    }

    try {
        let birthDate;
        
        // Jika data dari Google Sheets berupa format ISO (YYYY-MM-DDTHH:mm:ss.sssZ)
        // Kita ambil 10 karakter pertama saja (YYYY-MM-DD)
        if (typeof birthDateString === 'string' && birthDateString.includes('T')) {
            birthDateString = birthDateString.split('T')[0];
        }

        birthDate = new Date(birthDateString);

        // Jika gagal deteksi (Invalid Date), coba parsing manual format Indonesia DD/MM/YYYY
        if (isNaN(birthDate.getTime())) {
            let parts = birthDateString.toString().split(/[-/]/);
            if (parts.length === 3) {
                // Jika tahun di depan (YYYY-MM-DD)
                if (parts[0].length === 4) {
                    birthDate = new Date(parts[0], parts[1] - 1, parts[2]);
                } 
                // Jika tahun di belakang (DD-MM-YYYY)
                else {
                    birthDate = new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
        }

        // Cek lagi, kalau tetap bukan tanggal, menyerah
        if (isNaN(birthDate.getTime())) return { age: "-", gen: "-" };

        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }

        // Penentuan Generasi berdasarkan Tahun Lahir
        const year = birthDate.getFullYear();
        let gen = "Lainnya";
        if (year >= 1997 && year <= 2012) gen = "Gen Z";
        else if (year >= 1981 && year <= 1996) gen = "Millennial";
        else if (year >= 1965 && year <= 1980) gen = "Gen X";
        else if (year <= 1964) gen = "Boomer";

        return { 
            age: age >= 0 ? age + " Thn" : "-", 
            gen: gen 
        };
    } catch (e) {
        console.error("Error Hitung Umur:", e);
        return { age: "-", gen: "-" };
    }
}

    // 5. TAMPILKAN KE TABEL
function renderTable(data) {
    const body = document.getElementById('bodyKader');
    body.innerHTML = "";
    const sortedData = [...data].reverse();

    sortedData.forEach((item, index) => {
        const p = item.pribadi;
        const ageInfo = calculateAge(p.tgl_lahir);
        
        // Cek tingkat kaderisasi terakhir
        let tk = "Non-Kader";
        if(item.kaderisasi[6]) tk = "Utama"; else if(item.kaderisasi[4]) tk = "Madya"; else if(item.kaderisasi[2]) tk = "Pratama";

        body.innerHTML += `
            <tr onclick="openDetail(${index})">
                <td class="td-img"><img src="${formatDriveUrl(p.foto)}" onerror="this.src='https://ui-avatars.com/api/?name=${p.nama}'" style="width:45px; height:45px; border-radius:10px; object-fit:cover;"></td>
                <td><strong>${p.nama}</strong><br><small>${p.nik}</small></td>
                <td>${ageInfo.age}<br><span class="badge badge-gray">${ageInfo.gen}</span></td>
                <td>${p.kec}<br><small>${p.kota}</small></td>
                <td><span class="badge badge-red">${tk}</span></td>
            </tr>`;
    });
}

    // 6. UPDATE STATISTIK
    function updateStats(data) {
        const total = data.length;
        document.querySelector('.stats-grid .stat-card:nth-child(1) h2').innerText = total;
        
        const youngKader = data.filter(k => {
            const gen = calculateAge(k.tanggal_lahir).gen;
            return gen === "Gen Z" || gen === "Millennial";
        }).length;
        
        const percentYoung = total > 0 ? Math.round((youngKader / total) * 100) : 0;
        document.querySelector('.stats-grid .stat-card:nth-child(3) h2').innerText = percentYoung + "%";
        
        const wilayahUnik = [...new Set(data.map(k => k.kecamatan))].filter(Boolean).length;
        document.querySelector('.stats-grid .stat-card:nth-child(4) h2').innerText = wilayahUnik;
    }

    function toggleFilter() {
        const panel = document.getElementById('panelFilter');
        const btn = document.getElementById('btnToggle');
        if (panel.style.maxHeight === "0px" || !panel.style.maxHeight) {
            panel.style.maxHeight = "1000px"; panel.style.opacity = "1"; panel.style.padding = "20px";
            btn.innerText = "üìÇ Tutup Filter";
        } else {
            panel.style.maxHeight = "0px"; panel.style.opacity = "0"; panel.style.padding = "0px";
            btn.innerText = "üìÅ Buka Filter";
        }
    }

    function doSearch() {
        let input = document.getElementById('quickSearch').value.toUpperCase();
        let tr = document.getElementById("tableKader").getElementsByTagName("tr");
        for (let i = 1; i < tr.length; i++) {
            let txt = tr[i].textContent || tr[i].innerText;
            tr[i].style.display = txt.toUpperCase().indexOf(input) > -1 ? "" : "none";
        }
    }

function openDetail(index) {
    const sortedData = [...databaseKader].reverse();
    const item = sortedData[index];
    const p = item.pribadi;
    const f = item.formal;
    const k = item.kaderisasi;
    const m = item.medsos;

    document.getElementById('detFoto').src = formatDriveUrl(p.foto);
    document.getElementById('detNama').innerText = p.nama;

    // --- Template Detail Lengkap ---
    let html = `
        <div class="detail-grid">
            <div class="detail-section">
                <h3>üìå IDENTITAS LENGKAP</h3>
                <div><strong>NIK:</strong> ${p.nik}</div>
                <div><strong>TTL:</strong> ${p.tmpt_lahir}, ${p.tgl_lahir}</div>
                <div><strong>ALAMAT:</strong> ${p.alamat} RT ${p.rt}/RW ${p.rw}, ${p.desa}, ${p.kec}</div>
                <div><strong>KONTAK:</strong> ${p.wa}</div>
            </div>
            <div class="detail-section">
                <h3>üéì PENDIDIKAN FORMAL</h3>
                <div><strong>Terakhir:</strong> ${f[19] || '-'}</div>
                <div><strong>Kampus/Sekolah:</strong> ${f[11] || f[6] || '-'}</div>
            </div>
            <div class="detail-section">
                <h3>üö© KADERISASI & ORGANISASI</h3>
                <div><strong>Kaderisasi:</strong> ${k[2]?'Pratama':''} ${k[4]?'Madya':''} ${k[6]?'Utama':''}</div>
                <div><strong>Org. Lain:</strong> ${item.organisasi.map(o => o[2]).join(', ') || '-'}</div>
            </div>
            <div class="detail-section">
                <h3>üì± MEDIA SOSIAL</h3>
                <div><strong>FB:</strong> ${m[9] || '-'} | <strong>IG:</strong> ${m[10] || '-'}</div>
                <div><strong>TikTok:</strong> ${m[11] || '-'} | <strong>YT:</strong> ${m[13] || '-'}</div>
            </div>
        </div>
        <div class="detail-section" style="margin-top:15px;">
            <h3>üíº RIWAYAT JABATAN PARTAI</h3>
            <table style="font-size:11px; width:100%; background:#f8fafc; border-radius:10px;">
                ${item.jabatan.map(j => `<tr><td>${j[8]}</td><td>${j[5]}</td><td>${j[4]}</td></tr>`).join('')}
            </table>
        </div>
    `;

    document.getElementById('fullInfo').innerHTML = html; // Pastikan ada <div id="fullInfo"> di modal
    document.getElementById('modalDetail').style.display = "block";
}
    window.onload = fetchData;
</script>
</body>
</html>
