const GAS_URL = "https://script.google.com/macros/s/AKfycbz8ZZRmcSQsJm1m4VXk85311WDYMisGczcvZfm4j086FXjLNRobp7Q0hj9KEflmilWL2w/exec";
let MASTER_DATA = []; // Data asli dari server

// 1. Ambil Data
async function loadData() {
    try {
        const response = await fetch(GAS_URL + "?action=read", { redirect: "follow" });
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);

        // BALIK URUTAN: Biar yang terbaru masuk (paling bawah di Sheets) jadi yang paling atas
        MASTER_DATA = data.reverse();
        
        renderTable(MASTER_DATA);
        updateStats(MASTER_DATA);
    } catch (e) {
        document.getElementById("bodyKader").innerHTML = `<tr><td colspan="6" style="text-align:center; color:red; padding:30px;">Gagal memuat: ${e.message}</td></tr>`;
    }
}

// 2. Render Tabel
function renderTable(data) {
    const tbody = document.getElementById("bodyKader");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">Data tidak ditemukan.</td></tr>';
        return;
    }

    data.forEach((item, idx) => {
        const p = item.pribadi || {};
        const k = item.kaderisasi || [];
        const f = item.formal || [];
        
        // Logika Prioritas Madya
        const hasMadya = k.some(row => row[2].toLowerCase().includes("madya"));
        const pratama = k.find(row => row[2].toLowerCase().includes("pratama"));
        const isUrgent = (!hasMadya && pratama && (2026 - parseInt(pratama[5]) >= 5));

        // Styling Badge Kaderisasi
        const badges = k.map(row => {
            let color = row[2].toLowerCase().includes("madya") ? "#f59e0b" : "#D71920";
            return `<span class="badge" style="background:${color}15; color:${color}; border:1px solid ${color}30; font-size:10px; padding:2px 6px; margin:2px; border-radius:4px; display:inline-block; font-weight:bold;">${row[2]}</span>`;
        }).join("");

        const tr = document.createElement("tr");
        if (isUrgent) tr.style.backgroundColor = "#fff1f2"; // Background pink tipis untuk prioritas

        tr.innerHTML = `
            <td style="text-align:center;"><img src="${p.foto || 'https://ui-avatars.com/api/?name='+p.nama}" style="width:45px; height:45px; border-radius:10px; object-fit:cover; border:1px solid #eee;"></td>
            <td>
                <div style="font-weight:700; color:#1e293b;">${p.nama}</div>
                <div style="font-size:11px; color:#64748b;">KTA: ${p.kta || '-'}</div>
                <div style="font-size:10px; color:#94a3b8;">${p.kec || '-'}</div>
            </td>
            <td style="text-align:center; font-weight:600;">${p.umur || '-'}</td>
            <td style="font-size:12px;">${f[19] || '-'}</td>
            <td>${badges || '<small style="color:#cbd5e1">Anggota</small>'}</td>
            <td style="text-align:center;">
                <button onclick="showDetail(${idx})" style="padding:6px 12px; cursor:pointer; background:#D71920; color:white; border:none; border-radius:6px; font-size:11px; font-weight:600;">Detail</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 3. Fungsi Filter Gabungan (Semua Filter Aktif)
function applyFilters() {
    let result = [...MASTER_DATA];

    // Ambil semua nilai dropdown
    const fKota = document.getElementById("fKota").value;
    const fJK = document.getElementById("fJK").value;
    const fAgama = document.getElementById("fAgama").value;
    const fPendidikan = document.getElementById("fPendidikan").value;
    const fKader = document.getElementById("fKader").value;
    const fStatusMadya = document.getElementById("fStatusMadya").value;

    // Filter Kota
    if (fKota !== "Semua") result = result.filter(i => i.pribadi.kota === fKota);
    
    // Filter JK
    if (fJK !== "Semua") result = result.filter(i => i.pribadi.jk === fJK);
    
    // Filter Agama
    if (fAgama !== "Semua") result = result.filter(i => i.pribadi.agama === fAgama);

    // Filter Pendidikan (Ambil dari index 19 data formal)
    if (fPendidikan !== "Semua") result = result.filter(i => i.formal[19] === fPendidikan);

    // Filter Jenjang Kader (Spesifik)
    if (fKader !== "Semua") {
        result = result.filter(i => i.kaderisasi.some(k => k[2].toLowerCase().includes(fKader.toLowerCase())));
    }

    // Filter Status Madya / Prioritas
    if (fStatusMadya === "Sudah") {
        result = result.filter(i => i.kaderisasi.some(k => k[2].toLowerCase().includes("madya")));
    } else if (fStatusMadya === "Belum") {
        result = result.filter(i => !i.kaderisasi.some(k => k[2].toLowerCase().includes("madya")));
    } else if (fStatusMadya === "Prioritas") {
        result = result.filter(i => {
            const hasMadya = i.kaderisasi.some(k => k[2].toLowerCase().includes("madya"));
            const pratama = i.kaderisasi.find(k => k[2].toLowerCase().includes("pratama"));
            return !hasMadya && pratama && (2026 - parseInt(pratama[5]) >= 5);
        });
    }

    renderTable(result);
    updateStats(result);
}

// 4. Pencarian Cepat (Cari di semua kolom)
function doSearch() {
    const val = document.getElementById("quickSearch").value.toLowerCase();
    const result = MASTER_DATA.filter(item => 
        item.pribadi.nama.toLowerCase().includes(val) || 
        (item.pribadi.kta && item.pribadi.kta.includes(val)) ||
        (item.pribadi.kec && item.pribadi.kec.toLowerCase().includes(val))
    );
    renderTable(result);
}

// 5. Update Statistik
function updateStats(data) {
    document.getElementById("statTotal").innerText = data.length;
    
    // Gen Z & Milenial (Kelahiran > 1981 / Usia < 45)
    const young = data.filter(i => parseInt(i.pribadi.umur) < 45).length;
    document.getElementById("statYoung").innerText = young;

    // Total Madya
    const madya = data.filter(i => i.kaderisasi.some(k => k[2].toLowerCase().includes("madya"))).length;
    document.getElementById("statArea").innerText = madya;

    // Prioritas Madya
    const priority = data.filter(i => {
        const hasMadya = i.kaderisasi.some(k => k[2].toLowerCase().includes("madya"));
        const pratama = i.kaderisasi.find(k => k[2].toLowerCase().includes("pratama"));
        return !hasMadya && pratama && (2026 - parseInt(pratama[5]) >= 5);
    }).length;
    document.getElementById("statNeedMadya").innerText = priority;
}

// 6. Reset
function resetFilters() {
    document.querySelectorAll('select').forEach(s => s.value = "Semua");
    document.getElementById("quickSearch").value = "";
    renderTable(MASTER_DATA);
    updateStats(MASTER_DATA);
}

// 7. Toggle Filter Mobile
function toggleFilter() {
    const fBody = document.getElementById("filterBody");
    const icon = document.getElementById("filterIcon");
    if (fBody.style.display === "grid") {
        fBody.style.display = "none";
        icon.innerText = "▼";
    } else {
        fBody.style.display = "grid";
        icon.innerText = "▲";
    }
}

window.onload = loadData;
